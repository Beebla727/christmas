<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ£è¯æ‰‹åŠ¿äº’åŠ¨ Demo (ä¿®å¤ç‰ˆ)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        /* æ‘„åƒå¤´ç”»é¢ï¼ˆå·¦ä¸‹è§’é•œåƒæ˜¾ç¤ºï¼‰ */
        #video-input { 
            position: absolute; bottom: 20px; right: 20px; width: 160px; height: 120px; 
            transform: scaleX(-1); border-radius: 10px; opacity: 0.5; z-index: 2; pointer-events: none; 
        }
        
        /* UI ç•Œé¢ */
        #ui-layer { position: absolute; top: 20px; left: 20px; z-index: 10; color: #d4af37; pointer-events: none; }
        h1 { margin: 0; font-weight: 300; letter-spacing: 2px; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        .status { margin-top: 5px; font-size: 14px; color: #aaa; }
        #state-indicator, #gesture-indicator { color: #fff; font-weight: bold; }
        
        /* äº¤äº’æŒ‰é’® */
        #controls { pointer-events: auto; margin-top: 15px; }
        input[type="file"] { display: none; }
        .btn {
            background: linear-gradient(135deg, #d4af37, #b8860b);
            border: none; padding: 8px 16px; color: #000; font-weight: bold;
            cursor: pointer; border-radius: 20px; text-transform: uppercase; font-size: 12px;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3); transition: transform 0.2s; display: inline-block;
        }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(212, 175, 55, 0.6); }

        #loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #d4af37; z-index: 99; transition: opacity 0.5s; text-align: center;
        }
        .loading-text { margin-bottom: 20px; font-size: 1.2em; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <div id="loading">
        <div class="loading-text">æ­£åœ¨å¯åŠ¨ 3D å¼•æ“ä¸è§†è§‰è¯†åˆ«...<br><small>å¦‚æœé•¿æ—¶é—´æ²¡ååº”ï¼Œè¯·åˆ·æ–°é¡µé¢å¹¶ç¡®ä¿å…è®¸æ‘„åƒå¤´</small></div>
    </div>

    <div id="ui-layer">
        <h1>MERRY CHRISTMAS</h1>
        <div class="status">çŠ¶æ€: <span id="state-indicator">èšåˆ (TREE)</span></div>
        <div class="status">æ‰‹åŠ¿: <span id="gesture-indicator">æœªæ£€æµ‹</span></div>
        <div id="controls">
            <label class="btn">
                ä¸Šä¼ ç…§ç‰‡ ğŸ“¸
                <input type="file" id="photo-upload" accept="image/*" multiple>
            </label>
        </div>
        <div style="margin-top:10px; font-size: 12px; color: #666; max-width: 300px;">
            ç©æ³•: âœŠæ¡æ‹³=å˜æ ‘ | ğŸ–å¼ å¼€=ç‚¸å¼€ | ğŸ‘Œæåˆ=æŠ“ç…§ç‰‡ | â†”ï¸å¼ å¼€æ‰‹ç§»åŠ¨=æ—‹è½¬
        </div>
    </div>

    <video id="video-input" playsinline></video>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- é…ç½®åŒºåŸŸ ---
        const config = {
            colors: { green: 0x0B3B24, gold: 0xFFD700, red: 0x8B0000 },
            particleCount: 1200, 
            treeHeight: 35,      
            treeRadius: 14       
        };

        const state = { current: 'TREE', gesture: 'NONE', focusedPhotoIndex: -1 };

        // --- åˆå§‹åŒ–åœºæ™¯ ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.02);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 10, 50); 

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        container.appendChild(renderer.domElement);

        // --- åå¤„ç† ---
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.15; bloomPass.strength = 1.0; bloomPass.radius = 0.5;
        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // --- ç¯å…‰ä¸ç²’å­ ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.1));
        const pointLight = new THREE.PointLight(config.colors.gold, 2, 100);
        pointLight.position.set(0, 20, 10);
        scene.add(pointLight);
        scene.add(new THREE.PointLight(config.colors.red, 1, 50).translateY(5).translateX(-10));

        const particleGroup = new THREE.Group();
        const photoGroup = new THREE.Group();
        scene.add(particleGroup);
        scene.add(photoGroup);

        const particles = [];
        const sphereGeo = new THREE.SphereGeometry(0.3, 8, 8);
        const boxGeo = new THREE.BoxGeometry(0.4, 0.4, 0.4);
        const materials = {
            green: new THREE.MeshStandardMaterial({ color: config.colors.green, roughness: 0.8 }),
            gold: new THREE.MeshStandardMaterial({ color: config.colors.gold, metalness: 0.9, roughness: 0.1 }),
            red: new THREE.MeshStandardMaterial({ color: config.colors.red, metalness: 0.6, roughness: 0.3 })
        };

        function getTreePos(h, rBase, yNorm) {
            const y = yNorm * h - h/2 + 5;
            const r = rBase * (1 - yNorm);
            const angle = Math.random() * Math.PI * 2;
            return { x: Math.cos(angle) * r, y: y, z: Math.sin(angle) * r };
        }
        function getScatterPos(radius) {
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            const r = Math.cbrt(Math.random()) * radius;
            return { x: r * Math.sin(phi) * Math.cos(theta), y: r * Math.sin(phi) * Math.sin(theta), z: r * Math.cos(phi) };
        }

        for (let i = 0; i < config.particleCount; i++) {
            const type = Math.random();
            let mesh;
            if (type < 0.7) mesh = new THREE.Mesh(sphereGeo, materials.green);
            else if (type < 0.9) mesh = new THREE.Mesh(type>0.8?boxGeo:sphereGeo, materials.gold);
            else mesh = new THREE.Mesh(sphereGeo, materials.red);
            const yNorm = Math.random();
            const treePos = getTreePos(config.treeHeight, config.treeRadius, yNorm);
            const scatterPos = getScatterPos(30);
            mesh.position.set(treePos.x, treePos.y, treePos.z);
            mesh.userData = { treePos, scatterPos };
            particleGroup.add(mesh);
            particles.push(mesh);
        }

        const photoMeshes = [];
        const loader = new THREE.TextureLoader();
        for(let i=0; i<3; i++) createPhotoMesh(loader.load('https://picsum.photos/200/300'));

        function createPhotoMesh(texture) {
            const mat = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
            const mesh = new THREE.Mesh(new THREE.PlaneGeometry(3, 4), mat);
            const border = new THREE.Mesh(new THREE.PlaneGeometry(3.2, 4.4), new THREE.MeshBasicMaterial({color:0xffffff}));
            border.position.z = -0.01; mesh.add(border);
            const yNorm = Math.random();
            const treePos = getTreePos(config.treeHeight+2, config.treeRadius+2, yNorm);
            const scatterPos = getScatterPos(25);
            mesh.position.set(treePos.x, treePos.y, treePos.z);
            mesh.lookAt(0, treePos.y, 0);
            mesh.userData = { treePos, scatterPos, isPhoto: true };
            photoGroup.add(mesh); photoMeshes.push(mesh); particles.push(mesh);
        }

        document.getElementById('photo-upload').addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => createPhotoMesh(new THREE.Texture(img, THREE.UVMapping, THREE.RepeatWrapping, THREE.RepeatWrapping, THREE.LinearFilter, THREE.LinearFilter, THREE.RGBAFormat, THREE.UnsignedByteType, 1, THREE.LinearEncoding));
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            });
        });

        function transitionTo(newState) {
            if (state.current === newState && newState !== 'FOCUS') return;
            state.current = newState;
            document.getElementById('state-indicator').innerText = newState === 'TREE' ? 'èšåˆ (TREE)' : 'æ•£å¼€ (SCATTER)';
            particles.forEach(p => {
                if (newState === 'FOCUS' && p === photoMeshes[state.focusedPhotoIndex]) return;
                const target = (newState === 'TREE') ? p.userData.treePos : p.userData.scatterPos;
                new TWEEN.Tween(p.position).to(target, 1500).easing(TWEEN.Easing.Elastic.Out).start();
                new TWEEN.Tween(p.rotation).to({x:Math.random()*3, y:Math.random()*3}, 1500).start();
            });
            if (newState === 'TREE') {
                new TWEEN.Tween(camera.position).to({x:0, y:10, z:50}, 1000).start();
                camera.lookAt(0,0,0);
            }
        }

        // --- æ ¸å¿ƒä¿®å¤ï¼šç›´æ¥ä½¿ç”¨ Window ä¸Šçš„å¯¹è±¡ ---
        const videoElement = document.getElementById('video-input');
        
        // ç¡®ä¿ Hands å’Œ Camera å·²ç»åŠ è½½
        if (typeof window.Hands === 'undefined' || typeof window.Camera === 'undefined') {
            document.getElementById('loading').innerHTML = '<div class="loading-text" style="color:red">åŠ è½½å¤±è´¥<br><small>è¯·æ£€æŸ¥ç½‘ç»œæˆ–ä½¿ç”¨ç§‘å­¦ä¸Šç½‘</small></div>';
            throw new Error("MediaPipe libraries failed to load.");
        }

        const hands = new window.Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands: 1, minDetectionConfidence: 0.7});
        hands.onResults(onResults);

        const cameraFeed = new window.Camera(videoElement, {
            onFrame: async () => await hands.send({image: videoElement}),
            width: 640, height: 480
        });
        
        // å¯åŠ¨æ‘„åƒå¤´
        cameraFeed.start()
            .then(() => console.log("Camera started"))
            .catch(err => {
                console.error(err);
                document.getElementById('loading').innerText = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + err.message;
            });

        function onResults(results) {
            document.getElementById('loading').style.opacity = 0;
            if (!results.multiHandLandmarks.length) return;
            const lm = results.multiHandLandmarks[0];
            const wrist = lm[0];
            const fingers = [8, 12, 16, 20];
            const extended = fingers.filter(idx => Math.hypot(lm[idx].x - wrist.x, lm[idx].y - wrist.y) > 0.3).length;
            const pinchDist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
            let gesture = 'NONE';
            if (pinchDist < 0.05) gesture = 'PINCH';
            else if (extended === 4) gesture = 'OPEN';
            else if (extended === 0) gesture = 'FIST';

            if (gesture !== state.gesture) {
                state.gesture = gesture;
                document.getElementById('gesture-indicator').innerText = gesture === 'OPEN' ? 'ğŸ– å¼ å¼€' : (gesture === 'FIST' ? 'âœŠ æ¡æ‹³' : (gesture === 'PINCH' ? 'ğŸ‘Œ æåˆ' : 'æœªæ£€æµ‹'));
                if (gesture === 'FIST') transitionTo('TREE');
                else if (gesture === 'OPEN') transitionTo('SCATTER');
                else if (gesture === 'PINCH' && state.current === 'SCATTER') {
                    const idx = Math.floor(Math.random() * photoMeshes.length);
                    state.focusedPhotoIndex = idx;
                    const p = photoMeshes[idx];
                    new TWEEN.Tween(p.position).to({x:0, y:10, z:35}, 1000).start();
                    p.lookAt(camera.position);
                    state.current = 'FOCUS';
                }
            }
            if (state.current === 'SCATTER' && gesture === 'OPEN') {
                const moveX = (lm[9].x - 0.5) * 0.1;
                particleGroup.rotation.y += moveX;
                photoGroup.rotation.y += moveX;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            if (state.current === 'TREE') {
                particleGroup.rotation.y += 0.003;
                photoGroup.rotation.y += 0.003;
            }
            composer.render();
        }
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
        animate();
    </script>
</body>
</html>
